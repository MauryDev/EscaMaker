@using EscaMaker.View

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.ManageHistory" Class="mr-3 mb-n1" />
            Gerenciar Dados
        </MudText>
    </TitleContent>

    <DialogContent>
        <MudStepper @bind-ActiveIndex="ActiveStep" CurrentStepColor="Color.Primary">

            <MudStep Title="Origem" SecondaryText="Onde?">
                <MudText Align="Align.Center" Class="mb-4">Onde você deseja realizar a operação?</MudText>

                <MudGrid Justify="Justify.Center" Spacing="4">

                    <EscaMaker.Pages.Components.TransferComponents.ModeStorageSelect TValue="View.ModeTransfer"
                        Value="View.ModeTransfer.LocalStorage"
                        CurrentValue="@ModeTransfer"
                        Label="Navegador"
                        Description="LocalStorage"
                        Icon="@Icons.Material.Filled.Dns"
                        ActiveColor="Color.Primary"
                        Xs="12" Sm="6"
                        OnSelected="SelectMode" />

                    <EscaMaker.Pages.Components.TransferComponents.ModeStorageSelect TValue="View.ModeTransfer"
                        Value="View.ModeTransfer.File"
                        CurrentValue="@ModeTransfer"
                        Label="Arquivo"
                        Description="Upload/Download"
                        Icon="@Icons.Material.Filled.SnippetFolder"
                        ActiveColor="Color.Warning"
                        Xs="12" Sm="6"
                        OnSelected="SelectMode" />

                    <EscaMaker.Pages.Components.TransferComponents.ModeStorageSelect TValue="View.ModeTransfer"
                        Value="View.ModeTransfer.Cloud"
                        CurrentValue="@ModeTransfer"
                        Label="Cloud"
                        Description="Upload/Download"
                        Icon="@Icons.Material.Filled.Cloud"
                        ActiveColor="Color.Warning"
                        Xs="12" Sm="6"
                        OnSelected="SelectMode" />
      
                </MudGrid>
            </MudStep>

            <MudStep Title="Ação" SecondaryText="O que fazer?">
                <MudText Align="Align.Center" Class="mb-4">Selecione a operação desejada</MudText>




                <MudGrid Justify="Justify.Center" Spacing="2">

                    <EscaMaker.Pages.Components.TransferComponents.SelectAction ActionValue="View.ActionTransfer.Load"
                                                                                CurrentAction="@ActionTransfer"
                                                                                Label="Carregar"
                                                                                Icon="@Icons.Material.Filled.Download"
                                                                                OnSelected="SelectAction"/>
                    <EscaMaker.Pages.Components.TransferComponents.SelectAction ActionValue="View.ActionTransfer.Save"
                                                                                CurrentAction="@ActionTransfer"
                                                                                Label="Salvar"
                                                                                Icon="@Icons.Material.Filled.Upload"
                                                                                CanExecute="@CanSave"
                                                                                OnSelected="SelectAction"/>

                    <EscaMaker.Pages.Components.TransferComponents.SelectAction ActionValue="View.ActionTransfer.Delete"
                                                                                CurrentAction="@ActionTransfer"
                                                                                Label="Deletar"
                                                                                Icon="@Icons.Material.Filled.DeleteForever"
                                                                                CanExecute="@CanDelete"
                                                                                ActiveColor="Color.Error"
                                                                                OnSelected="SelectAction" />

                </MudGrid>
            </MudStep>

            <MudStep Title="Executar" SecondaryText="Finalização">
                <MudPaper Class="pa-4 mt-4" Outlined="true">

                    @RenderTransfer()

                </MudPaper>
            </MudStep>
        </MudStepper>
    </DialogContent>

    <DialogActions>
        @if (ActiveStep > 0)
        {
            <MudButton OnClick="@(() => ActiveStep--)" Variant="Variant.Text">Voltar</MudButton>
        }
        <MudSpacer />
        <MudButton OnClick="Cancel" Color="Color.Default">Cancelar</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .border-2 {
        border-width: 2px !important;
    }

    .border-primary {
        border-color: var(--mud-palette-primary) !important;
    }
</style>

@code {
    static Dictionary<View.ModeTransfer, Type> ModeToComponentMap = new()
    {
        { View.ModeTransfer.LocalStorage, typeof(EscaMaker.Pages.Components.TransferComponents.LocalStorageFinalize) },
        { View.ModeTransfer.File, typeof(EscaMaker.Pages.Components.TransferComponents.FileFinalize) },
        { View.ModeTransfer.Cloud, typeof(EscaMaker.Pages.Components.TransferComponents.CloudFinalize) },
    };
    [CascadingParameter] public required IMudDialogInstance MudDialog { get; set; }
    [Parameter] public LocalScheduleData? EscalaLocalData { get; set; }


    public int ActiveStep { get; set; }

    public View.ActionTransfer ActionTransfer { get; set; } = View.ActionTransfer.None;
    public View.ModeTransfer ModeTransfer { get; set; } = View.ModeTransfer.None;

    bool CanSave => EscalaLocalData is not null;
    bool CanDelete => ModeTransfer != View.ModeTransfer.File;

    private async Task SelectMode(View.ModeTransfer mode)
    {
        ModeTransfer = mode;
        ActionTransfer = View.ActionTransfer.None;

        await Task.Delay(200);
        ActiveStep = 1;
    }

    private async void SelectAction(View.ActionTransfer action)
    {
        if (!CanSave && action == View.ActionTransfer.Save)
            return;

        if (!CanDelete && action == View.ActionTransfer.Delete)
            return;
        ActionTransfer = action;
        await Task.Delay(200);
        ActiveStep = 2;

    }

    private string GetActionClass(View.ActionTransfer action, bool disabled = false)
    {
        if (disabled) return "pa-4 d-flex flex-column align-center mud-theme-dark lighten-4 opacity-50 cursor-not-allowed";

        var baseClass = "pa-4 d-flex flex-column align-center cursor-pointer transition-all";
        if (ActionTransfer == action)
            return $"{baseClass} border-solid border-2 border-primary mud-theme-primary lighten-5";

        return $"{baseClass} hover:mud-elevation-8";
    }
    public Dictionary<string, object?> GetArguments()
    {
        return new(){
            { "ActionTransfer", ActionTransfer },
            {"EscalaLocalData", EscalaLocalData },
            {"MudDialog", MudDialog }
        };
    }
    private RenderFragment RenderTransfer()
    {
        var type = ModeToComponentMap.GetValueOrDefault(ModeTransfer);
        return __builder =>
        {
            if (type is not null)
            {
                <DynamicComponent Type="type"
                                  Parameters="GetArguments()" />
            }
            else
            {
                <MudAlert Severity="Severity.Info">Selecione as opções anteriores para continuar.</MudAlert>

            }
        };

    }
    void Cancel() => MudDialog.Cancel();
}