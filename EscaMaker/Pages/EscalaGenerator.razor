@page "/escala-create"
@inject Services.PDFEscala EscalaService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Criar Escala</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-4">

    <MudPaper Square Outlined Class="pa-4">
        <MudGrid Spacing="4">
            <MudItem xs="12" sm="6">
                <MudDatePicker Label="Mês e Ano"  @bind-Date="_yearMonth" OpenTo="OpenTo.Year" FixDay="1" DateFormat="MM/yyyy" />

            </MudItem>

            
        </MudGrid>

        <MudGrid Spacing="4" Class="mt-4">
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButtonGroup OverrideStyles="false" FullWidth Class="escalagenerator-button">
                    <MudButton Disabled="@IsEmpty" Color="Color.Primary" Variant="Variant.Filled" Class="escalagenerator-button" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="Generate">Gerar Escala</MudButton>
                    <MudMenu Disabled="IsEmpty" FullWidth Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                        <MudMenuItem OnClick="GenerateMesAtual" Icon="@Icons.Material.Filled.CalendarMonth">Mês Atual</MudMenuItem>
                        <MudMenuItem OnClick="GenerateMesProximo" Icon="@Icons.Material.Filled.CalendarMonth">Próximo Mês</MudMenuItem>
                    </MudMenu>
                </MudButtonGroup>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButtonGroup OverrideStyles="false" FullWidth>
                    <MudButton  Color="Color.Primary" Variant="Variant.Filled" Class="escalagenerator-button" StartIcon="@Icons.Material.Filled.PictureAsPdf" Disabled="@IsScheduleEmpty" OnClick="GeneratePDF">Download PDF</MudButton>
                    <MudMenu FullWidth Disabled="@IsScheduleEmpty" Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                        <MudMenuItem OnClick="GeneratePreview" Icon="@Icons.Material.Filled.Visibility">Pré-visualizar</MudMenuItem>
                    </MudMenu>
                </MudButtonGroup>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.PersonSearch"
                           Variant="Variant.Filled" Class="escalagenerator-button" Disabled="@IsScheduleEmpty"
                OnClick="GenerateInfo">Escalas por Pessoa</MudButton>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.DateRange"
                           Variant="Variant.Filled" Class="escalagenerator-button" Disabled="@IsScheduleEmpty"
                OnClick="SelectPeriodo">Escalas por Período</MudButton>
            </MudItem>


            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Info" StartIcon="@Icons.Material.Filled.Source"
                           Variant="Variant.Filled" Class="escalagenerator-button" OnClick="SelectEscalaTransfer">Gerenciar Dados</MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton Disabled="@IsScheduleEmpty" FullWidth Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.ClearAll" Variant="Variant.Filled" Class="escalagenerator-button" OnClick="ClearSchedulesAsync">Limpar</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (IsScheduleEmpty)
    {
        <MudCard Class="mt-8 pa-6" Elevation="0" Outlined>
            <div class="d-flex flex-column align-center justify-center" Style="min-height: 300px;">
                <MudIcon Icon="@Icons.Material.Filled.EventNote"
                         Size="Size.Large"
                         Color="Color.Secondary"
                         Class="mb-4"
                         Style="font-size: 4rem; opacity: 0.5;" />
                <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-2">
                    Nenhuma escala gerada
                </MudText>
                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                    Selecione um mês e ano nos campos acima para começar.
                </MudText>
            </div>
        </MudCard>
    }
    else
    {
        <EscaMaker.Pages.Components.EscalasView escalaTipos="@escalaTipos" Mes="@MesSelected" />
        
    }
</MudContainer>




    @code {
    // State
    public DateTime? _yearMonth { get; set; }
    int MesSelected { get; set; } = 1;
    int AnoSelected { get; set; } = 1;


    string Nome_PreviewGP { get; set; } = string.Empty;
    IEnumerable<(string? Name, byte, string)>? DiasAndFuncao { get; set; }

    View.EscalaInfo[] escalasInfo;
    bool NoGenerated = true;
    private View.EscalaTipoView[] escalaTipos;

    // Computed
    private bool IsScheduleEmpty => NoGenerated;
    public bool IsEmpty => !_yearMonth.HasValue;

    private IEnumerable<List<List<string>>?> escalaTipoNomes
    {
        get
        {
            return escalaTipos.Select(x => x.Names);
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        escalasInfo = View.EscalaInfo.LoadFromResource();
        escalaTipos = new View.EscalaTipoView[escalasInfo.Length];
        for (int i = 0; i < escalaTipos.Length; i++)
        {
            var info = escalasInfo[i];
            escalaTipos[i] = new View.EscalaTipoView
            {
                Name = info.Name,
                Headers = info.GetHeaders(),
                Datas = GetDatas(info)
            };
        }
    }

    private Func<IEnumerable<IEnumerable<byte>>> GetDatas(View.EscalaInfo escalaInfo) =>
        () => escalaInfo.GetDatas(MesSelected, AnoSelected);


    private void ShowSnackbar(string message, Severity severity) => Snackbar.Add(message, severity);

    private void Generate()
    {
        
        if (_yearMonth.HasValue)
        {
            NoGenerated = false;
            MesSelected = _yearMonth?.Month ?? 1;
            AnoSelected = (_yearMonth?.Year) ?? 1;
        } else
        {
            ShowSnackbar("Por favor, insira um mês e ano válidos para gerar a escala.", Severity.Error);

        }


        ShowSnackbar($"Escala gerada para {Utils.DateTimeUtil.GetMesNome(MesSelected)}/{AnoSelected}.", Severity.Success);
    }

    private void GenerateMesAtual()
    {
        var now = DateTime.Now;
        _yearMonth = new DateTime(now.Year, now.Month, 1);
        

        Generate();
        if (!IsScheduleEmpty)
            ShowSnackbar($"Escala gerada para o mês atual ({Utils.DateTimeUtil.GetMesNome(MesSelected)})/{AnoSelected}.",
            Severity.Success);
    }

    private void GenerateMesProximo()
    {
        var next = DateTime.Now.AddMonths(1);
        _yearMonth = new DateTime(next.Year, next.Month, 1);

        Generate();
        if (!IsScheduleEmpty)
            ShowSnackbar($"Escala gerada para o próximo mês ({Utils.DateTimeUtil.GetMesNome(MesSelected)})/{AnoSelected}.",
            Severity.Success);
    }

    async Task GeneratePDF()
    {
        try
        {
            var bytes = Utils.GeneratePDF.GeneratePDFDocument(MesSelected, AnoSelected,
                escalaTipoNomes, escalasInfo);

            if (bytes == null)
            {
                ShowSnackbar("Erro ao gerar PDF. Verifique os dados.", Severity.Error);
                return;
            }

            await EscalaService.GeneratePDF(bytes, "escala.pdf");
            ShowSnackbar("PDF gerado e download iniciado.", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"PDF Generation Error: {ex}");
            ShowSnackbar($"Erro ao gerar PDF: {ex.Message}", Severity.Error);
        }
    }

    private async Task GeneratePreview()
    {
        string? lastPreviewUrl = null;
        try
        {
            var bytes = Utils.GeneratePDF.GeneratePDFDocument(MesSelected, AnoSelected,
                escalaTipoNomes, escalasInfo);
            lastPreviewUrl = await EscalaService.GeneratePreview(bytes);
            var parameters = new DialogParameters { { "LastPreviewUrl", lastPreviewUrl } };

            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
            await DialogService.ShowAsync<Components.Preview.PDFPreview>("Preview PDF", parameters, options);
            ShowSnackbar("Pré-visualização do PDF carregada.", Severity.Info);
        }
        catch (Exception ex)
        {
            ShowSnackbar($"Erro ao gerar pré-visualização: {ex.Message}", Severity.Error);
            await CleanupPreview(lastPreviewUrl);
        }
    }

    private async Task CleanupPreview(string? url)
    {
        if (!string.IsNullOrEmpty(url))
        {
            await EscalaService.DeletePreview(url);
        }
    }

    private void UpdateEscala(View.EscalaLocalData escalaLocalData)
    {
        _yearMonth = new DateTime(escalaLocalData.Ano, escalaLocalData.Mes, 1);
       
        MesSelected = escalaLocalData.Mes;
        AnoSelected = escalaLocalData.Ano;
        var min = Math.Min(escalaLocalData.Nomes.Length, escalaTipos.Length);
        for (int i = 0; i < min; i++)
        {
            escalaTipos[i].Names = escalaLocalData.Nomes[i];
        }

        Generate();
    }
    void CreateEscala(View.EscalaLocalData escalaLocalData)
    {
        _yearMonth = new DateTime(escalaLocalData.Ano, escalaLocalData.Mes, 1);

        MesSelected = escalaLocalData.Mes;
        AnoSelected = escalaLocalData.Ano;
        escalasInfo = escalaLocalData.EscalasInfo.Clone() as View.EscalaInfo[];
        escalaTipos = escalaLocalData.Nomes.Zip(escalaLocalData.EscalasInfo).Select(e => new View.EscalaTipoView()
        {
            Names = e.First,
            Datas = GetDatas(e.Second),
            Headers = e.Second.GetHeaders(),
        }).ToArray();

        Generate();
    }

    private async Task GenerateInfo()
    {

        var parameters = new DialogParameters<Components.Preview.EPStepper>
        {
            {(e) => e.Names, Components.Preview.EPSelectName.GetPersonNomesEscala(escalaTipos) },
            {(e) => e.Mes, MesSelected },
            {(e) => e.Ano, AnoSelected },
            {(e) => e.EscalaTipos, escalaTipos }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<Components.Preview.EPStepper>("Seleciona Nome", parameters, options);
    }




    private async Task OpenPeriodoView(int diaInicial, int diaFinal)
    {
        var responsavelInfos = Components.EscalaPeriodoView.SelectByPeriodo(escalaTipos, diaInicial, diaFinal);
        var parameters = new DialogParameters<Components.EscalaPeriodoView>
        {
            { "responsavelInfos", responsavelInfos },
            { "Date", (MesSelected, AnoSelected) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<Components.EscalaPeriodoView>("Visualização do período", parameters, options);
    }

    private async Task SelectPeriodo()
    {
        var parameters = new DialogParameters<Components.EscalaPeriodoSelect>
        {
            { "Mes", MesSelected },
            { "Ano", AnoSelected }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<Components.EscalaPeriodoSelect>("Seleção de período", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled)
        {
            ShowSnackbar("Seleção de período cancelada.", Severity.Info);
            return;
        }

        if (result.Data is int dia)
        {
            await OpenPeriodoView(dia, dia);
            ShowSnackbar($"Visualizando escala para o dia {dia:D02}/{MesSelected:D02}.", Severity.Success);
        }
        else if (result.Data is ValueTuple<int, int> span)
        {
            await OpenPeriodoView(span.Item1, span.Item2);
            ShowSnackbar($"Visualizando escala para o período de {span.Item1:D02} a {span.Item2:D02}/{MesSelected:D02}.",
            Severity.Success);
        }
    }



    private async Task ClearSchedulesAsync()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            "Tem certeza que deseja limpar TODAS as escalas? Esta ação não pode ser desfeita.",
            yesText: "Sim, Limpar", cancelText: "Cancelar");

        if (result == true)
        {
            foreach (var tipo in escalaTipos)
            {
                tipo.Clear();
            }
            ShowSnackbar("Escalas limpas com sucesso.", Severity.Success);
        }
    }



    public async Task SelectEscalaTransfer()
    {
        var escalaData = IsScheduleEmpty ? null : new View.EscalaLocalData
        {
            Ano = AnoSelected,
            Mes = (byte)MesSelected,
            Nomes = escalaTipoNomes.ToArray()!,
            EscalasInfo = escalasInfo.Clone() as View.EscalaInfo[]
        };

        var parameters = new DialogParameters { { "escalaLocalData", escalaData } };
        var dialog = await DialogService.ShowAsync<Components.TransferSelect>("", parameters);
        var result = await dialog.Result;

        if (!(result?.Canceled ?? true) && result.Data is View.EscalaLocalData data)
        {
            UpdateEscala(data);
        }
    }
}