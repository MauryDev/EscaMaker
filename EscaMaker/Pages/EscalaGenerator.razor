@page "/escala-create"
@inject Services.PDFEscala EscalaService
@inject Services.Contracts.IEscalaDataTransferService EscalaDataTransferService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject Services.AdminApiService AdminApiService

<PageTitle>Criar Escala</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-4">
    <MudPaper Square Outlined Class="pa-4">
        <MudGrid Spacing="4">
            <MudItem xs="12" sm="6">
                <MudNumericField @bind-Value="Ano"
                                 Label="Ano"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 Max="10000" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudSelect T="int" @bind-Value="Mes" Label="Mês" Variant="Variant.Outlined">
                    @for (int m = 1; m <= 12; m++)
                    {
                        var curm = m;
                        <MudSelectItem Value="@m">@Utils.DateTimeUtil.GetMesNome(curm)</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>

        <MudGrid Spacing="4" Class="mt-4">
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButtonGroup OverrideStyles="false" FullWidth Style="border-radius:24px;">
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Style="border-radius:24px;" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="Generate">Gerar Escala</MudButton>
                    <MudMenu FullWidth Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                        <MudMenuItem OnClick="GenerateMesAtual" Icon="@Icons.Material.Filled.CalendarMonth">Mês Atual</MudMenuItem>
                        <MudMenuItem OnClick="GenerateMesProximo" Icon="@Icons.Material.Filled.CalendarMonth">Próximo Mês</MudMenuItem>
                    </MudMenu>
                </MudButtonGroup>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButtonGroup OverrideStyles="false" FullWidth>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" Style="border-radius:24px;" StartIcon="@Icons.Material.Filled.PictureAsPdf" Disabled="@IsScheduleEmpty" OnClick="GeneratePDF">Download PDF</MudButton>
                    <MudMenu FullWidth Disabled="@IsScheduleEmpty" Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                        <MudMenuItem OnClick="GeneratePreview" Icon="@Icons.Material.Filled.Visibility">Pré-visualizar</MudMenuItem>
                    </MudMenu>
                </MudButtonGroup>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Primary" StartIcon="@Icons.Material.Filled.PersonSearch" Variant="Variant.Filled" Style="border-radius:24px;" Disabled="@IsScheduleEmpty" OnClick="GenerateInfo">Escalas por Pessoa</MudButton>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Primary" StartIcon="@Icons.Material.Filled.DateRange" Variant="Variant.Filled" Style="border-radius:24px;" Disabled="@IsScheduleEmpty" OnClick="SelectPeriodo">Escalas por Período</MudButton>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Primary" StartIcon="@Icons.Material.Filled.Cloud" Variant="Variant.Filled" Style="border-radius:24px;" OnClick="CloudTools">Cloud</MudButton>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Primary" StartIcon="@Icons.Material.Filled.Source" Variant="Variant.Filled" Style="border-radius:24px;" OnClick="SelectEscalaTransfer">Gerenciar Dados</MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton Disabled="@IsScheduleEmpty" FullWidth Color="Color.Primary" StartIcon="@Icons.Material.Filled.ClearAll" Variant="Variant.Filled" Style="border-radius:24px;" OnClick="ClearSchedules">Limpar</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (IsScheduleEmpty)
    {
        <MudText Class="mt-8 text-center" Typo="Typo.h6">Selecione um ano e mês para gerar a escala.</MudText>
    }
    else
    {
        <MudText Class="mt-8 mb-4 text-center" Typo="Typo.h4" Align="Align.Center">Mês de @GetMesName()</MudText>
        <MudDivider DividerType="DividerType.FullWidth" />

        <MudGrid Spacing="4">
            @for (int idx = 0; idx < escalaTipos.Length; idx++)
            {
                var cur = idx;
                <MudItem xs="12" sm="6" md="4">
                    <EscaMaker.Pages.Components.EscalaTipo EscalaTipo_View="@escalaTipos[cur]" />
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

<MudOverlay @bind-Visible="_visible" AutoClose="true" Class="justify-center align-center">
    <iframe style="width: 80vw; height: 80vh" src="@LastPreviewUrl"></iframe>
</MudOverlay>

<MudOverlay Visible="@(_modePersonInfo != 0)" DarkBackground>
    <div style="width:60vw; min-width:250px; height:70vh; min-height:400px; overflow-y:scroll;">
        @if (_modePersonInfo == 2)
        {
            <EscaMaker.Pages.Components.PreviewGP Mes="@MesSelected" Nome="@Nome_PreviewGP" DiasAndFuncao="DiasAndFuncao" OnClose="OnClosePreview" Ano="Ano" />
        }
        else if (_modePersonInfo == 1)
        {
            <EscaMaker.Pages.Components.PreviewGPName Names="Components.PreviewGPName.GetPersonNomesEscala(escalaTipos)" OnClose="OnClosePreview" OnOk="OnOkPreviewName" />
        }
    </div>
</MudOverlay>

@code {
    // State
    private int Ano { get; set; } = 1;
    private int Mes { get; set; } = 1;
    private int MesSelected { get; set; } = 1;

    private List<byte>? Sabados { get; set; }
    private List<byte>? Domingos { get; set; }
    private List<byte>? Quartas { get; set; }

    private string? LastPreviewUrl { get; set; }
    private bool _visible { get; set; }
    private int _modePersonInfo { get; set; }
    private string Nome_PreviewGP { get; set; } = string.Empty;
    private IEnumerable<(string? Name, byte, string)>? DiasAndFuncao { get; set; }

    private static readonly Utils.EscalaInfo[] escalasInfo = new[]
    {
        new Utils.EscalaInfo("Momento Prévios", Utils.EscalaInfo.DiasType.SDQ),
        new Utils.EscalaInfo("Louvor Especial", Utils.EscalaInfo.DiasType.SDQ),
        new Utils.EscalaInfo("Sonoplastia", Utils.EscalaInfo.DiasType.SDQ),
        new Utils.EscalaInfo("Pregação", Utils.EscalaInfo.DiasType.SDQ),
        new Utils.EscalaInfo("Recepção", Utils.EscalaInfo.DiasType.DQ),
        new Utils.EscalaInfo("Programação", Utils.EscalaInfo.DiasType.DQ),
        new Utils.EscalaInfo("Escola Sabatina", Utils.EscalaInfo.DiasType.S),
        new Utils.EscalaInfo("Diácono", Utils.EscalaInfo.DiasType.S),
        new Utils.EscalaInfo("Professor", Utils.EscalaInfo.DiasType.S)
    };

    private View.EscalaTipoView[] escalaTipos = new View.EscalaTipoView[escalasInfo.Length];

    private Utils.EscalaTransfer.IEscalaTransfer? EscalaActions { get; set; }

    // Computed
    private bool IsScheduleEmpty => Sabados == null || Domingos == null || Quartas == null;

    private IEnumerable<List<List<string>>?> escalaTipoNomes => escalaTipos.Select(x => x.Names);

    protected override void OnInitialized()
    {
        base.OnInitialized();

        EscalaActions = EscalaDataTransferService.GetLocalStorageProvider();

        for (int i = 0; i < escalaTipos.Length; i++)
        {
            var info = escalasInfo[i];
            escalaTipos[i] = new View.EscalaTipoView
            {
                Name = info.Name,
                Headers = info.GetHeaders(),
                Datas = GetDatas(info)
            };
        }
    }

    private Func<IEnumerable<IEnumerable<byte>>> GetDatas(Utils.EscalaInfo escalaInfo) =>
        () => escalaInfo.GetDatas(GetDatasValues());

    private string GetMesName() => Utils.DateTimeUtil.GetMesNome(MesSelected);

    private void ShowSnackbar(string message, Severity severity) => Snackbar.Add(message, severity);

    private void Generate()
    {
        if (Mes is <= 0 or > 12 || Ano <= 0)
        {
            ShowSnackbar("Por favor, insira um mês e ano válidos para gerar a escala.", Severity.Error);
            return;
        }

        Sabados = Utils.DateTimeUtil.Days(Mes, Ano, DayOfWeek.Saturday);
        Domingos = Utils.DateTimeUtil.Days(Mes, Ano, DayOfWeek.Sunday);
        Quartas = Utils.DateTimeUtil.Days(Mes, Ano, DayOfWeek.Wednesday);
        MesSelected = Mes;

        ShowSnackbar($"Escala gerada para {Utils.DateTimeUtil.GetMesNome(Mes)}/{Ano}.", Severity.Success);
    }

    private void GenerateMesAtual()
    {
        var now = DateTime.Now;
        Mes = now.Month;
        Ano = now.Year;

        Generate();
        if (!IsScheduleEmpty) ShowSnackbar($"Escala gerada para o mês atual ({Utils.DateTimeUtil.GetMesNome(Mes)})/{Ano}.", Severity.Success);
    }

    private void GenerateMesProximo()
    {
        var next = DateTime.Now.AddMonths(1);
        Mes = next.Month;
        Ano = next.Year;
        Generate();
        if (!IsScheduleEmpty) ShowSnackbar($"Escala gerada para o próximo mês ({Utils.DateTimeUtil.GetMesNome(Mes)})/{Ano}.", Severity.Success);
    }

    private async Task GeneratePDF()
    {
        var bytes = Utils.GeneratePDF.GeneratePDFDocument(MesSelected, GetDatasValues(), escalaTipoNomes, escalasInfo);
        await EscalaService.GeneratePDF(bytes, "escala.pdf");
        ShowSnackbar("PDF gerado e download iniciado.", Severity.Success);
    }

    private async Task GeneratePreview()
    {
        var bytes = Utils.GeneratePDF.GeneratePDFDocument(MesSelected, GetDatasValues(), escalaTipoNomes, escalasInfo);

        if (!string.IsNullOrEmpty(LastPreviewUrl))
        {
            await EscalaService.DeletePreview(LastPreviewUrl);
            LastPreviewUrl = null;
        }

        LastPreviewUrl = await EscalaService.GeneratePreview(bytes);
        _visible = true;
        ShowSnackbar("Pré-visualização do PDF carregada.", Severity.Info);
    }

    private IEnumerable<IEnumerable<byte>> GetDatasValues() => new[] { Sabados!, Domingos!, Quartas! }.AsEnumerable();

    private void UpdateEscala(Utils.EscalaLocalData escalaLocalData)
    {
        Ano = escalaLocalData.Ano;
        Mes = escalaLocalData.Mes;
        MesSelected = escalaLocalData.Mes;

        var min = Math.Min(escalaLocalData.Nomes.Length, escalaTipos.Length);
        for (int i = 0; i < min; i++)
        {
            escalaTipos[i].Names = escalaLocalData.Nomes[i];
        }

        Generate();
    }

    private void GenerateInfo() => _modePersonInfo = 1;

    private void OnOkPreviewName(string name)
    {
        DiasAndFuncao = View.EscalaTipoView.GetDias(escalaTipos, name);
        Nome_PreviewGP = name;
        _modePersonInfo = 2;
        this.StateHasChanged();
    }

    private void OnClosePreview() => _modePersonInfo = 0;

    private async Task OpenPeriodoView(int diaInicial, int diaFinal)
    {
        var responsavelInfos = Components.EscalaPeriodoView.SelectByPeriodo(escalaTipos, diaInicial, diaFinal);
        var parameters = new DialogParameters<Components.EscalaPeriodoView>
        {
            { "responsavelInfos", responsavelInfos },
            { "Date", (Mes, Ano) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<Components.EscalaPeriodoView>("Visualização do período", parameters, options);
    }

    private async Task SelectPeriodo()
    {
        var parameters = new DialogParameters<Components.EscalaPeriodoSelect>
        {
            { "Mes", MesSelected },
            { "Ano", Ano }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<Components.EscalaPeriodoSelect>("Seleção de período", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled)
        {
            ShowSnackbar("Seleção de período cancelada.", Severity.Info);
            return;
        }

        if (result.Data is int dia)
        {
            await OpenPeriodoView(dia, dia);
            ShowSnackbar($"Visualizando escala para o dia {dia:D02}/{MesSelected:D02}.", Severity.Success);
        }
        else if (result.Data is ValueTuple<int, int> span)
        {
            await OpenPeriodoView(span.Item1, span.Item2);
            ShowSnackbar($"Visualizando escala para o período de {span.Item1:D02} a {span.Item2:D02}/{MesSelected:D02}.", Severity.Success);
        }
    }

    private void ClearSchedules()
    {
        foreach (var tipo in escalaTipos)
        {
            for (int groupIndex = 0; groupIndex < tipo.Names.Count; groupIndex++)
            {
                var group = tipo.Names[groupIndex];
                for (int itemIndex = 0; itemIndex < group.Count; itemIndex++)
                {
                    group[itemIndex] = string.Empty;
                }
            }
        }

        ShowSnackbar("Todas as escalas foram limpas com sucesso.", Severity.Info);
    }

    private async Task CloudTools()
    {
        var escalaData = IsScheduleEmpty ? null : new Utils.EscalaLocalData
        {
            Ano = Ano,
            Mes = (byte)MesSelected,
            Nomes = escalaTipoNomes.ToArray()!
        };

        var dialogOptions = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        var parameters = new DialogParameters<Components.CloudEscalaTransfer> { { (e) => e.EscalaLocalData, escalaData } };
        var dialog = await DialogService.ShowAsync<Components.CloudEscalaTransfer>("Ferramenta de cloud", parameters, dialogOptions);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is Components.CloudEscalaTransfer.ReturnValue value && value.TransferType == Components.CloudEscalaTransfer.TransferType.Read && value.value is Utils.EscalaLocalData data)
        {
            UpdateEscala(data);
        }
    }

    public async Task SelectEscalaTransfer()
    {
        var escalaData = IsScheduleEmpty ? null : new Utils.EscalaLocalData
        {
            Ano = Ano,
            Mes = (byte)MesSelected,
            Nomes = escalaTipoNomes.ToArray()!
        };

        var parameters = new DialogParameters { { "escalaLocalData", escalaData } };
        var dialog = await DialogService.ShowAsync<Components.TransferSelect>("", parameters);
        var result = await dialog.Result;

        if (!(result?.Canceled ?? true) && result.Data is Utils.EscalaLocalData data)
        {
            UpdateEscala(data);
        }
    }
}