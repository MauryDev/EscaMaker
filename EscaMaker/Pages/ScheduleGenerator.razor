@page "/escala-create"
@using EscaMaker.Utils
@inject Services.PDFSchedule EscalaService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Criar Escala</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="my-4">

    <MudPaper Square Outlined Class="pa-4">
        <MudGrid Spacing="4">
            <MudItem xs="12" sm="6">
                <MudDatePicker Label="Mês e Ano"  @bind-Date="_yearMonth" OpenTo="OpenTo.Year" FixDay="1" DateFormat="MM/yyyy" />
            </MudItem>
        </MudGrid>

        <MudGrid Spacing="4" Class="mt-4">
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButtonGroup OverrideStyles="false" FullWidth Class="escalagenerator-button">
                    <MudButton Disabled="@IsEmpty" Color="Color.Primary" Variant="Variant.Filled" Class="escalagenerator-button" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="Generate">Gerar Escala</MudButton>
                    <MudMenu FullWidth Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                        <MudMenuItem OnClick="GenerateCurrentMonth" Icon="@Icons.Material.Filled.CalendarMonth">Mês Atual</MudMenuItem>
                        <MudMenuItem OnClick="GenerateNextMonth" Icon="@Icons.Material.Filled.CalendarMonth">Próximo Mês</MudMenuItem>
                    </MudMenu>
                </MudButtonGroup>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButtonGroup OverrideStyles="false" FullWidth>
                    <MudButton  Color="Color.Primary" Variant="Variant.Filled" Class="escalagenerator-button" StartIcon="@Icons.Material.Filled.PictureAsPdf" Disabled="@IsScheduleEmpty" OnClick="GeneratePDF">Download PDF</MudButton>
                    <MudMenu FullWidth Disabled="@IsScheduleEmpty" Color="Color.Primary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.ArrowDropDown" Style="align-self: auto;">
                        <MudMenuItem OnClick="GeneratePreview" Icon="@Icons.Material.Filled.Visibility">Pré-visualizar</MudMenuItem>
                    </MudMenu>
                </MudButtonGroup>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.PersonSearch"
                           Variant="Variant.Filled" Class="escalagenerator-button" Disabled="@IsScheduleEmpty"
                OnClick="GenerateInfo">Escalas por Pessoa</MudButton>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.DateRange"
                           Variant="Variant.Filled" Class="escalagenerator-button" Disabled="@IsScheduleEmpty"
                OnClick="SelectPeriodo">Escalas por Período</MudButton>
            </MudItem>

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton FullWidth Color="Color.Info" StartIcon="@Icons.Material.Filled.Source"
                           Variant="Variant.Filled" Class="escalagenerator-button" OnClick="SelectEscalaTransfer">Gerenciar Dados</MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudButton Disabled="@IsScheduleEmpty" FullWidth Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.ClearAll" Variant="Variant.Filled" Class="escalagenerator-button" OnClick="ClearSchedulesAsync">Limpar</MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (IsScheduleEmpty)
    {
        <MudCard Class="mt-8 pa-6" Elevation="0" Outlined>
            <div class="d-flex flex-column align-center justify-center" Style="min-height: 300px;">
                <MudIcon Icon="@Icons.Material.Filled.EventNote"
                         Size="Size.Large"
                         Color="Color.Secondary"
                         Class="mb-4"
                         Style="font-size: 4rem; opacity: 0.5;" />
                <MudText Typo="Typo.h6" Align="Align.Center" Class="mb-2">
                    Nenhuma escala gerada
                </MudText>
                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Secondary">
                    Selecione um mês e ano nos campos acima para começar.
                </MudText>
            </div>
        </MudCard>
    }
    else
    {
        <EscaMaker.Pages.Components.SchedulesView escalaTipos="@schedulesType" Mes="@selectedMonth" />
        
    }
</MudContainer>

@code {
    // State
    DateTime? _yearMonth { get; set; }
    int selectedMonth { get; set; } = 1;
    int selectedYear { get; set; } = 1;


    IEnumerable<(string? Name, byte, string)>? DaysAndFunction { get; set; }

    View.ScheduleInfo[] schedulesInfo { get; set; } = null!;
    bool NoGenerated { get; set; } = true;
    View.ScheduleTypeView[] schedulesType { get; set; } = null!;

    // Computed
    bool IsScheduleEmpty => NoGenerated;
    bool IsEmpty => !_yearMonth.HasValue;

    IEnumerable<List<List<string>>?> scheduleTypeNames
    {
        get
        {
            return schedulesType.Select(x => x.Names);
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        schedulesInfo = View.ScheduleInfo.LoadFromResource()!;
        schedulesType = new View.ScheduleTypeView[schedulesInfo.Length];
        for (int i = 0; i < schedulesType.Length; i++)
        {
            var info = schedulesInfo[i];
            schedulesType[i] = new View.ScheduleTypeView
            {
                Name = info.Name,
                Headers = info.GetHeaders(),
                Dates = GetDates(info)
            };
        }
    }

    Func<IEnumerable<IEnumerable<byte>>> GetDates(View.ScheduleInfo scheduleInfo) =>
        () => scheduleInfo.GetDates(selectedMonth, selectedYear);


    void ShowSnackbar(string message, Severity severity) => Snackbar.Add(message, severity);

    void Generate()
    {

        if (_yearMonth.HasValue)
        {
            NoGenerated = false;
            selectedMonth = _yearMonth?.Month ?? 1;
            selectedYear = (_yearMonth?.Year) ?? 1;
            ShowSnackbar($"Escala gerada para {Utils.DateTimeUtil.GetMonthName(selectedMonth)}/{selectedYear}.", Severity.Success);
            return;
        }
        ShowSnackbar("Por favor, insira um mês e ano válidos para gerar a escala.", Severity.Error);


    }

    void GenerateCurrentMonth()
    {
        _yearMonth = DateTime.Now.ToFirstDayOfMonth();


        Generate();
        if (!IsScheduleEmpty)
            ShowSnackbar($"Escala gerada para o mês atual ({Utils.DateTimeUtil.GetMonthName(selectedMonth)})/{selectedYear}.",
            Severity.Success);
    }

    void GenerateNextMonth()
    {
        _yearMonth = DateTime.Now.AddMonths(1).ToFirstDayOfMonth();

        Generate();
        if (!IsScheduleEmpty)
            ShowSnackbar($"Escala gerada para o próximo mês ({Utils.DateTimeUtil.GetMonthName(selectedMonth)})/{selectedYear}.",
            Severity.Success);
    }

    async Task GeneratePDF()
    {
        try
        {
            if (scheduleTypeNames == null || scheduleTypeNames == null)
            {
                ShowSnackbar("Nenhum dado de escala disponível para gerar o PDF.", Severity.Warning);
                return;
            }
            var bytes = Utils.GeneratePDF.GeneratePDFDocument(selectedMonth, selectedYear,
                scheduleTypeNames!, schedulesInfo);

            if (bytes == null)
            {
                ShowSnackbar("Erro ao gerar PDF. Verifique os dados.", Severity.Error);
                return;
            }

            await EscalaService.GeneratePDF(bytes, "escala.pdf");
            ShowSnackbar("PDF gerado e download iniciado.", Severity.Success);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"PDF Generation Error: {ex}");
            ShowSnackbar($"Erro ao gerar PDF: {ex.Message}", Severity.Error);
        }
    }

    async Task GeneratePreview()
    {
        string? lastPreviewUrl = null;
        try
        {
            if (schedulesInfo == null || scheduleTypeNames == null)
            {
                ShowSnackbar("Nenhum dado de escala disponível para gerar a pré-visualização.", Severity.Warning);
                return;
            }
            var bytes = await Task.Run(() => Utils.GeneratePDF.GeneratePDFDocument(selectedMonth, selectedYear,
                scheduleTypeNames!, schedulesInfo));
            lastPreviewUrl = await EscalaService.GeneratePreview(bytes!);
            var parameters = new DialogParameters { { "LastPreviewUrl", lastPreviewUrl } };

            var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
            await DialogService.ShowAsync<Components.Preview.PDFPreview>("Preview PDF", parameters, options);
            ShowSnackbar("Pré-visualização do PDF carregada.", Severity.Info);
        }
        catch (Exception ex)
        {
            ShowSnackbar($"Erro ao gerar pré-visualização: {ex.Message}", Severity.Error);
            await CleanupPreview(lastPreviewUrl);
        }
    }

    async Task CleanupPreview(string? url)
    {
        if (!string.IsNullOrEmpty(url))
        {
            await EscalaService.DeletePreview(url);
        }
    }

    void UpdateSchedule(View.LocalScheduleData escalaLocalData)
    {
        _yearMonth = new DateTime(escalaLocalData.Year, escalaLocalData.Month, 1);

        selectedMonth = escalaLocalData.Month;
        selectedYear = escalaLocalData.Year;
        var min = Math.Min(escalaLocalData.Names.Length, schedulesType.Length);
        for (int i = 0; i < min; i++)
        {
            schedulesType[i].Names = escalaLocalData.Names[i];
        }

        Generate();
    }
    void CreateSchedule(View.LocalScheduleData escalaLocalData)
    {
        _yearMonth = new DateTime(escalaLocalData.Year, escalaLocalData.Month, 1);

        selectedMonth = escalaLocalData.Month;
        selectedYear = escalaLocalData.Year;
        schedulesInfo = escalaLocalData.SchedulesInfo.Clone() as View.ScheduleInfo[];
        schedulesType = escalaLocalData.Names.Zip(escalaLocalData.SchedulesInfo).Select(e => new View.ScheduleTypeView()
        {
            Names = e.First,
            Dates = GetDates(e.Second),
            Headers = e.Second.GetHeaders(),
        }).ToArray();

        Generate();
    }

    async Task GenerateInfo()
    {

        var parameters = new DialogParameters<Components.Preview.EPStepper>
        {
            {(e) => e.Names, Components.Preview.EPSelectName.GetPersonNomesEscala(schedulesType) },
            {(e) => e.Month, selectedMonth },
            {(e) => e.Year, selectedYear },
            {(e) => e.EscalaTipos, schedulesType }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<Components.Preview.EPStepper>("Seleciona Nome", parameters, options);
    }




    async Task OpenPeriodoView(int diaInicial, int diaFinal)
    {
        var responsavelInfos = Components.SchedulePeriodView.SelectByPeriodo(schedulesType, diaInicial, diaFinal);
        var parameters = new DialogParameters<Components.SchedulePeriodView>
        {
            { e => e.responsavelInfos, responsavelInfos },
            { e => e.Date, (selectedMonth, selectedYear) }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<Components.SchedulePeriodView>("Visualização do período", parameters, options);
    }

    async Task SelectPeriodo()
    {
        var parameters = new DialogParameters<Components.SchedulePeriodSelect>
        {
            { e => e.Mes, selectedMonth },
            { e => e.Ano, selectedYear }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<Components.SchedulePeriodSelect>("Seleção de período", parameters, options);
        var result = await dialog.Result;

        if (result?.Canceled ?? true)
        {
            ShowSnackbar("Seleção de período cancelada.", Severity.Info);
            return;
        }

        if (result.Data is int dia)
        {
            await OpenPeriodoView(dia, dia);
            ShowSnackbar($"Visualizando escala para o dia {dia:D02}/{selectedMonth:D02}.", Severity.Success);
        }
        else if (result.Data is ValueTuple<int, int> span)
        {
            await OpenPeriodoView(span.Item1, span.Item2);
            ShowSnackbar($"Visualizando escala para o período de {span.Item1:D02} a {span.Item2:D02}/{selectedMonth:D02}.",
            Severity.Success);
        }
    }

    async Task ClearSchedulesAsync()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirmar Exclusão",
            "Tem certeza que deseja limpar TODAS as escalas? Esta ação não pode ser desfeita.",
            yesText: "Sim, Limpar", cancelText: "Cancelar");

        if (result == true)
        {
            foreach (var tipo in schedulesType)
            {
                tipo.Clear();
            }
            ShowSnackbar("Escalas limpas com sucesso.", Severity.Success);
        }
    }



    async Task SelectEscalaTransfer()
    {
        var escalaData = IsScheduleEmpty ? null : new View.LocalScheduleData
        {
            Year = selectedYear,
            Month = (byte)selectedMonth,
            Names = scheduleTypeNames.ToArray()!,
            SchedulesInfo = schedulesInfo.Clone() as View.ScheduleInfo[]
        };

        var parameters = new DialogParameters<Components.TransferSelect> {
            { e => e.EscalaLocalData, escalaData }
        };
        var dialog = await DialogService.ShowAsync<Components.TransferSelect>("", parameters);
        var result = await dialog.Result;

        if (!(result?.Canceled ?? true) && result.Data is View.LocalScheduleData data)
        {
            UpdateSchedule(data);
        }
    }
}